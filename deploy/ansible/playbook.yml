# =============================================================================
# Storm Cloud Server - Deployment Playbook
# =============================================================================
#
# One-command deployment for Storm Cloud Server.
#
# Usage:
#   make deploy                    # From project root
#   make deploy-check              # Dry run (no changes)
#   make deploy-app                # Update app only
#
# Manual:
#   cd deploy/ansible
#   ansible-playbook playbook.yml -i inventory.yml --extra-vars "@../config.yml"
#
# =============================================================================

---
- name: Deploy Storm Cloud Server
  hosts: all
  become: true

  vars:
    app_user: "{{ app_user | default('stormcloud') }}"
    install_path: "/home/{{ app_user }}/storm-cloud-server"
    web_port: "{{ web_port | default('8000') }}"
    cors_origins: "{{ cors_origins | default('') }}" # CORS origins from config.yml

  # ===========================================================================
  # PROMPTS
  # ===========================================================================

  vars_prompt:
    - name: gotosocial_username
      prompt: "GoToSocial username (press ENTER to skip GoToSocial account setup)"
      private: false
      default: ""

    - name: gotosocial_email
      prompt: "GoToSocial email (required if username provided)"
      private: false
      default: ""

    - name: gotosocial_password
      prompt: "GoToSocial password (minimum 16 characters, required if username provided)"
      private: true
      default: ""

  # ===========================================================================
  # PRE-FLIGHT
  # ===========================================================================

  pre_tasks:
    - name: Validate config
      ansible.builtin.assert:
        that:
          - server_ip | default('') | length > 0
          - domain | default('') | length > 0
          - admin_email | default('') | length > 0
          - postgres_password | default('') | length > 0
        fail_msg: |

          ══════════════════════════════════════════════════════════════
          Missing required config. Edit deploy/config.yml:

            server_ip:       {{ server_ip | default('(empty)') }}
            domain:          {{ domain | default('(empty)') }}
            admin_email:     {{ admin_email | default('(empty)') }}
            postgres_password: {{ postgres_password | default('(empty)') }}

          ══════════════════════════════════════════════════════════════
      tags: [always]

    - name: Validate GoToSocial config
      ansible.builtin.assert:
        that:
          - gotosocial_domain | default('') | length > 0
        fail_msg: |

          ══════════════════════════════════════════════════════════════
          GoToSocial is enabled but gotosocial_domain is not set.
          Edit deploy/config.yml and set:

            gotosocial_domain: "social.example.com"

          ══════════════════════════════════════════════════════════════
      when: install_gotosocial | default(false)
      tags: [always]

    - name: Show GoToSocial account skip message
      ansible.builtin.debug:
        msg: |

          ══════════════════════════════════════════════════════════════
          ℹ️  GoToSocial Account Setup Skipped
          ══════════════════════════════════════════════════════════════
          
          GoToSocial server will be installed but no account will be created.
          
          To create an account after deployment:
            ssh {{ ssh_user | default('root') }}@{{ server_ip }}
            su - {{ app_user }}
            make gotosocial-user
            make gotosocial-token
          
          ══════════════════════════════════════════════════════════════
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length == 0
      tags: [always]

    - name: Validate GoToSocial account info
      ansible.builtin.assert:
        that:
          - gotosocial_email | default('') | length > 0
          - gotosocial_password | default('') | length >= 16
        fail_msg: |

          ══════════════════════════════════════════════════════════════
          ❌ GoToSocial Account Setup Incomplete
          ══════════════════════════════════════════════════════════════
          
          You provided username "{{ gotosocial_username }}" but email or password is invalid.
          
          To create a GoToSocial account during deployment, provide ALL of:
            - username (you provided: {{ gotosocial_username }})
            - email (missing or empty)
            - password (minimum 16 characters required)

          The account will automatically be promoted to admin.
          
          Or press Ctrl+C then 'A' to abort and skip account creation.
          ══════════════════════════════════════════════════════════════
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
      tags: [always]

    - name: Check if nginx is already installed
      ansible.builtin.command: which nginx
      register: nginx_preinstalled
      failed_when: false
      changed_when: false
      tags: [always]

    - name: Detect existing nginx configurations
      ansible.builtin.find:
        paths: /etc/nginx/sites-enabled
        file_type: any
      register: existing_nginx_configs
      when: nginx_preinstalled.rc == 0
      tags: [always]

    - name: Warn about existing nginx installation
      ansible.builtin.pause:
        prompt: |
          
          ══════════════════════════════════════════════════════════════
          ⚠️  EXISTING NGINX INSTALLATION DETECTED
          ══════════════════════════════════════════════════════════════
          
          Found {{ existing_nginx_configs.matched | default(0) }} existing config(s) in /etc/nginx/sites-enabled/
          
          Storm Cloud will:
          1. Remove /etc/nginx/sites-enabled/default (if exists)
          2. Remove /etc/nginx/sites-enabled/stormcloud (old symlink without .conf)
          3. Create /etc/nginx/sites-enabled/stormcloud.conf
          {% if install_gotosocial | default(false) %}
          4. Create /etc/nginx/sites-enabled/gotosocial.conf (for GoToSocial)
          {% endif %}
          
          ⚠️  Other existing configs will NOT be removed automatically.
          ⚠️  If you have CloudPanel or other control panels, conflicts may occur.
          
          The following configs currently exist:
          {% for item in existing_nginx_configs.files %}
            - {{ item.path }}
          {% endfor %}
          
          Press ENTER to continue or Ctrl+C then 'A' to abort...
          
      when:
        - nginx_preinstalled.rc == 0
        - existing_nginx_configs.matched | default(0) > 0
      tags: [always]

    - name: Show deployment info
      ansible.builtin.debug:
        msg: |

          ══════════════════════════════════════════════════════════════
          Deploying Storm Cloud Server

            Server:  {{ server_ip }}
            Domain:  {{ domain }}
            User:    {{ app_user }}
          {% if install_gotosocial | default(false) %}

            GoToSocial: {{ gotosocial_domain }}
          {% endif %}
          ══════════════════════════════════════════════════════════════
      tags: [always]

  # ===========================================================================
  # ROLES
  # ===========================================================================

  roles:
    - role: geerlingguy.docker
      when: install_docker | default(true)
      vars:
        docker_users: ["{{ app_user }}"]
      tags: [docker]

  # ===========================================================================
  # TASKS
  # ===========================================================================

  tasks:
    # -------------------------------------------------------------------------
    # System
    # -------------------------------------------------------------------------

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: [system]

    - name: Install packages
      ansible.builtin.apt:
        name: [git, curl, ufw, acl]
        state: present
      tags: [system]

    - name: Create app user
      ansible.builtin.user:
        name: "{{ app_user }}"
        shell: /bin/bash
        groups: docker
        append: true
      tags: [system]

    # -------------------------------------------------------------------------
    # Firewall
    # -------------------------------------------------------------------------

    - name: Allow SSH
      community.general.ufw:
        rule: allow
        name: OpenSSH
      when: configure_firewall | default(true)
      tags: [firewall]

    - name: Allow HTTP
      community.general.ufw:
        rule: allow
        port: "80"
      when: configure_firewall | default(true)
      tags: [firewall]

    - name: Allow HTTPS
      community.general.ufw:
        rule: allow
        port: "443"
      when: configure_firewall | default(true)
      tags: [firewall]

    - name: Enable firewall
      community.general.ufw:
        state: enabled
        policy: deny
      when: configure_firewall | default(true)
      tags: [firewall]

    # -------------------------------------------------------------------------
    # Nginx (initial)
    # -------------------------------------------------------------------------

    - name: Install nginx
      ansible.builtin.apt:
        name: nginx
        state: present
      when: install_nginx | default(true)
      tags: [nginx]

    - name: Create certbot webroot
      ansible.builtin.file:
        path: /var/www/certbot
        state: directory
        mode: "0755"
      tags: [nginx]

    - name: Check if SSL cert exists
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      register: ssl_cert
      tags: [nginx, ssl]

    - name: Deploy pre-SSL nginx config
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/stormcloud
        mode: "0644"
        content: |
          server {
              listen 80;
              server_name {{ domain }};

              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }

              location / {
                  return 200 'Storm Cloud - awaiting SSL\n';
                  add_header Content-Type text/plain;
              }
          }
      when:
        - install_nginx | default(true)
        - not ssl_cert.stat.exists | default(true)
      notify: Reload nginx
      tags: [nginx]

    - name: Enable site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/stormcloud
        dest: /etc/nginx/sites-enabled/stormcloud.conf
        state: link
      when: install_nginx | default(true)
      notify: Reload nginx
      tags: [nginx]

    - name: Check if GoToSocial SSL cert exists
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ gotosocial_domain }}/fullchain.pem"
      register: gotosocial_ssl_cert_initial
      when: install_gotosocial | default(false)
      tags: [nginx, ssl, gotosocial]

    - name: Deploy pre-SSL nginx config for GoToSocial
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/gotosocial
        mode: "0644"
        content: |
          server {
              listen 80;
              server_name {{ gotosocial_domain }};

              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }

              location / {
                  return 200 'GoToSocial - awaiting SSL\n';
                  add_header Content-Type text/plain;
              }
          }
      when:
        - install_gotosocial | default(false)
        - install_nginx | default(true)
        - not (gotosocial_ssl_cert_initial.stat.exists | default(false))
      notify: Reload nginx
      tags: [nginx, gotosocial]

    - name: Enable GoToSocial site (pre-SSL only)
      ansible.builtin.file:
        src: /etc/nginx/sites-available/gotosocial
        dest: /etc/nginx/sites-enabled/gotosocial.conf
        state: link
      when:
        - install_gotosocial | default(false)
        - install_nginx | default(true)
        - not (gotosocial_ssl_cert_initial.stat.exists | default(false))
      notify: Reload nginx
      tags: [nginx, gotosocial]

    - name: Remove default site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx
      tags: [nginx]

    - name: Remove old stormcloud symlink (without .conf extension)
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/stormcloud
        state: absent
      notify: Reload nginx
      tags: [nginx]

    - name: Remove old gotosocial symlink (without .conf extension)
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/gotosocial
        state: absent
      when: install_gotosocial | default(false)
      notify: Reload nginx
      tags: [nginx, gotosocial]

    - name: Start nginx
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
      when: install_nginx | default(true)
      tags: [nginx]

    - name: Flush handlers for certbot
      ansible.builtin.meta: flush_handlers
      tags: [nginx, ssl]

    # -------------------------------------------------------------------------
    # SSL
    # -------------------------------------------------------------------------

    - name: Install certbot
      ansible.builtin.apt:
        name: [certbot, python3-certbot-nginx]
        state: present
      when: install_certbot | default(true)
      tags: [ssl]

    - name: Get SSL certificate
      ansible.builtin.command:
        cmd: >-
          certbot certonly --webroot
          --webroot-path=/var/www/certbot
          --email {{ admin_email }}
          --agree-tos --no-eff-email --non-interactive
          -d {{ domain }}
        creates: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      when: install_certbot | default(true)
      tags: [ssl]

    - name: Get SSL certificate for GoToSocial
      ansible.builtin.command:
        cmd: >-
          certbot certonly --webroot
          --webroot-path=/var/www/certbot
          --email {{ admin_email }}
          --agree-tos --no-eff-email --non-interactive
          -d {{ gotosocial_domain }}
        creates: "/etc/letsencrypt/live/{{ gotosocial_domain }}/fullchain.pem"
      when:
        - install_gotosocial | default(false)
        - install_certbot | default(true)
      tags: [ssl, gotosocial]

    - name: Re-check SSL cert
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      register: ssl_cert_final
      tags: [nginx, ssl]

    - name: Re-check GoToSocial SSL cert
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ gotosocial_domain }}/fullchain.pem"
      register: gotosocial_ssl_cert
      when: install_gotosocial | default(false)
      tags: [nginx, ssl, gotosocial]

    - name: Deploy full nginx config
      ansible.builtin.template:
        src: templates/nginx-stormcloud.conf.j2
        dest: /etc/nginx/sites-available/stormcloud
        mode: "0644"
      when:
        - install_nginx | default(true)
        - ssl_cert_final.stat.exists
        - (not install_gotosocial | default(false)) or (gotosocial_ssl_cert.stat.exists | default(false))
      notify: Reload nginx
      tags: [nginx, ssl]

    - name: Remove temporary GoToSocial nginx config
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/nginx/sites-enabled/gotosocial.conf
        - /etc/nginx/sites-available/gotosocial
      when:
        - install_gotosocial | default(false)
        - gotosocial_ssl_cert.stat.exists | default(false)
      notify: Reload nginx
      tags: [nginx, ssl, gotosocial]

    # -------------------------------------------------------------------------
    # Application
    # -------------------------------------------------------------------------

    - name: Check if git repo exists
      ansible.builtin.stat:
        path: "{{ install_path }}/.git"
      become: true  # Need elevated permissions to check ownership
      register: git_dir
      tags: [app]

    - name: Check if install directory exists
      ansible.builtin.stat:
        path: "{{ install_path }}"
      become: true  # Need elevated permissions to check ownership
      register: install_dir
      tags: [app]

    # ADD THIS RIGHT HERE
    - name: DEBUG stat results
      ansible.builtin.debug:
        var: install_dir
      tags: [app]

    # =========================================================================
    # Git Recovery - Handle broken deployment states
    # =========================================================================
    # If directory exists but .git is missing, we have a partial deployment.
    # Instead of nuking the directory (losing .env, uploads/, gotosocial_data/),
    # we initialize git in-place and hard reset to the target branch.
    # =========================================================================

    - name: Fix directory ownership (if owned by root)
      ansible.builtin.file:
        path: "{{ install_path }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: true
      become: true
      when:
        - install_dir.stat.exists | default(false)
        - not (git_dir.stat.exists | default(false))
        - install_dir.stat.pw_name is defined and install_dir.stat.pw_name == 'root'
      tags: [app, git-recovery]

    - name: Initialize git repository (recovery mode)
      ansible.builtin.command:
        cmd: git init
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when:
        - install_dir.stat.exists | default(false)
        - not (git_dir.stat.exists | default(false))
      register: git_init_result
      changed_when: "'Initialized' in git_init_result.stdout or 'Reinitialized' in git_init_result.stdout"
      tags: [app, git-recovery]

    - name: Add remote origin (recovery mode)
      ansible.builtin.command:
        cmd: "git remote add origin {{ repo_url | default('https://github.com/smattymatty/storm-cloud-server.git') }}"
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when:
        - install_dir.stat.exists | default(false)
        - not (git_dir.stat.exists | default(false))
      register: git_remote_result
      failed_when: false  # Ignore error if remote already exists
      changed_when: git_remote_result.rc == 0
      tags: [app, git-recovery]

    - name: Set remote URL (if remote already existed)
      ansible.builtin.command:
        cmd: "git remote set-url origin {{ repo_url | default('https://github.com/smattymatty/storm-cloud-server.git') }}"
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when:
        - install_dir.stat.exists | default(false)
        - not (git_dir.stat.exists | default(false))
        - git_remote_result is defined and git_remote_result.rc != 0
      tags: [app, git-recovery]

    - name: Fetch from remote (recovery mode)
      ansible.builtin.command:
        cmd: "git fetch origin {{ git_branch | default('main') }}"
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when:
        - install_dir.stat.exists | default(false)
        - not (git_dir.stat.exists | default(false))
      register: git_fetch_result
      changed_when: true
      tags: [app, git-recovery]

    - name: Hard reset to target branch (recovery mode)
      ansible.builtin.command:
        cmd: "git reset --hard origin/{{ git_branch | default('main') }}"
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when:
        - install_dir.stat.exists | default(false)
        - not (git_dir.stat.exists | default(false))
      register: git_reset_result
      changed_when: true
      tags: [app, git-recovery]

    - name: Set git_result for recovery path
      ansible.builtin.set_fact:
        git_result:
          changed: true
          failed: false
      when:
        - install_dir.stat.exists | default(false)
        - not (git_dir.stat.exists | default(false))
        - git_reset_result is succeeded
      tags: [app, git-recovery]

    # =========================================================================
    # Normal Git Clone/Update - Runs when directory doesn't exist OR .git exists
    # =========================================================================

    - name: Clone repository
      ansible.builtin.git:
        repo: "{{ repo_url | default('https://github.com/smattymatty/storm-cloud-server.git') }}"
        dest: "{{ install_path }}"
        version: "{{ git_branch | default('main') }}"
        update: true
      become_user: "{{ app_user }}"
      register: git_result
      when:
        - not (install_dir.stat.exists | default(false) and not (git_dir.stat.exists | default(false)))
      tags: [app]

    - name: Create directories
      ansible.builtin.file:
        path: "{{ install_path }}/{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        mode: "0750"  # More secure: no world-read access
      loop: [uploads, backups]
      when: git_result is succeeded  # Only create if git clone succeeded
      tags: [app]

    - name: Create GoToSocial data directory
      ansible.builtin.file:
        path: "{{ install_path }}/gotosocial_data"
        state: directory
        owner: "{{ gotosocial_uid | default('1000') }}"
        group: "{{ gotosocial_uid | default('1000') }}"
        mode: "0755"
      when:
        - install_gotosocial | default(false)
        - git_result is succeeded  # Only create if git clone succeeded
      tags: [app, gotosocial]

    # -------------------------------------------------------------------------
    # Secrets (idempotent)
    # -------------------------------------------------------------------------

    - name: Check for existing .env
      ansible.builtin.stat:
        path: "{{ install_path }}/.env"
      register: env_check
      tags: [app, env]

    # First deploy: generate new secrets
    - name: Generate secrets (new install)
      ansible.builtin.set_fact:
        secret_key: "{{ lookup('password', '/dev/null length=50 chars=ascii_letters,digits') }}"
        db_password: "{{ postgres_password }}"
      when: not env_check.stat.exists
      tags: [app, env]

    # Existing deploy: read and preserve secrets
    - name: Read existing .env
      ansible.builtin.slurp:
        src: "{{ install_path }}/.env"
      register: env_content
      when: env_check.stat.exists
      tags: [app, env]

    - name: Parse existing secrets
      ansible.builtin.set_fact:
        secret_key: "{{ env_content.content | b64decode | regex_search('SECRET_KEY=([^\\s#]+)', '\\1', multiline=True) | default([''], true) | first }}"
        db_password: "{{ env_content.content | b64decode | regex_search('POSTGRES_PASSWORD=([^\\s#]+)', '\\1', multiline=True) | default([''], true) | first }}"
      when: env_check.stat.exists
      tags: [app, env]

    - name: Validate parsed secrets
      ansible.builtin.assert:
        that:
          - secret_key | default('') | length > 0
          - db_password | default('') | length > 0
        fail_msg: |

          ══════════════════════════════════════════════════════════════
          ❌ Failed to parse secrets from existing .env file
          ══════════════════════════════════════════════════════════════
          
          The existing .env file at {{ install_path }}/.env appears to be
          corrupted or missing required SECRET_KEY and POSTGRES_PASSWORD values.
          
          Please either:
          1. Fix the .env file manually on the server
          2. Remove the .env file to generate new secrets (WARNING: will break existing data)
          
          ══════════════════════════════════════════════════════════════
      when: env_check.stat.exists
      tags: [app, env]

    - name: Write .env
      ansible.builtin.template:
        src: templates/dotenv.j2
        dest: "{{ install_path }}/.env"
        owner: "{{ app_user }}"
        mode: "0600"
      no_log: true  # Prevent secrets from appearing in logs
      tags: [app, env]

    # -------------------------------------------------------------------------
    # Docker
    # -------------------------------------------------------------------------

    - name: Build images (fresh rebuild)
      ansible.builtin.command:
        cmd: docker compose build --no-cache
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when: git_result.changed
      tags: [app, docker]

    - name: Start containers
      ansible.builtin.command:
        cmd: "docker compose {{ '--profile gotosocial' if install_gotosocial | default(false) else '' }} up -d --remove-orphans"
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      register: up_result
      changed_when: "'Started' in up_result.stdout or 'Creating' in up_result.stdout"
      tags: [app, docker]

    - name: Wait for healthy
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ web_port }}/api/v1/health/ping/"
        status_code: 200
      register: health
      until: health.status == 200
      retries: 30
      delay: 2
      tags: [app, docker]

    # -------------------------------------------------------------------------
    # GoToSocial Account Setup
    # -------------------------------------------------------------------------

    - name: Wait for GoToSocial healthy
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 8081
        delay: 5
        timeout: 60
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
      tags: [app, gotosocial]

    - name: Create GoToSocial account
      ansible.builtin.command:
        cmd: >-
          docker exec stormcloud_gotosocial
          /gotosocial/gotosocial admin account create
          --username {{ gotosocial_username }}
          --email {{ gotosocial_email }}
          --password {{ gotosocial_password }}
      become_user: "{{ app_user }}"
      register: gts_create
      failed_when: false
      changed_when: "'created' in gts_create.stdout.lower() or 'Created' in gts_create.stdout"
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
        - gotosocial_email | default('') | length > 0
        - gotosocial_password | default('') | length > 0
      tags: [app, gotosocial]

    - name: Confirm GoToSocial account
      ansible.builtin.command:
        cmd: >-
          docker exec stormcloud_gotosocial
          /gotosocial/gotosocial admin account confirm
          --username {{ gotosocial_username }}
      become_user: "{{ app_user }}"
      register: gts_confirm
      failed_when: false
      changed_when: "'confirmed' in gts_confirm.stdout.lower() or 'Confirmed' in gts_confirm.stdout"
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
        - gts_create is defined
      tags: [app, gotosocial]

    - name: Promote GoToSocial account to admin
      ansible.builtin.command:
        cmd: >-
          docker exec stormcloud_gotosocial
          /gotosocial/gotosocial admin account promote
          --username {{ gotosocial_username }}
      become_user: "{{ app_user }}"
      register: gts_promote
      failed_when: false
      changed_when: "'promoted' in gts_promote.stdout.lower() or 'Promoted' in gts_promote.stdout"
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
        - gts_confirm is defined
      tags: [app, gotosocial]

    - name: Restart GoToSocial for admin changes
      ansible.builtin.command:
        cmd: docker restart stormcloud_gotosocial
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when:
        - install_gotosocial | default(false)
        - gts_promote is defined
        - gts_promote is changed
      tags: [app, gotosocial]

    # -------------------------------------------------------------------------
    # Done
    # -------------------------------------------------------------------------

    - name: Success
      ansible.builtin.debug:
        msg: |

          ══════════════════════════════════════════════════════════════
          ✓ Deployed!
          ══════════════════════════════════════════════════════════════

          Live at: https://{{ domain }}

          Next steps:

            ssh {{ ssh_user | default('root') }}@{{ server_ip }}
            su - {{ app_user }}
            cd {{ install_path }}
            make superuser
            make api_key
          {% if install_gotosocial | default(false) %}

          ──────────────────────────────────────────────────────────────
          GoToSocial: https://{{ gotosocial_domain }}
          {% if gotosocial_username | default('') | length > 0 %}

            ✓ Account created: {{ gotosocial_username }}
            ✓ Admin privileges granted

            Next: Generate API token for Django integration
              make gotosocial-token
          {% else %}

            ⚠️  No account created during deployment.
            
            To create your first user account:
              make gotosocial-user   (interactive)
              make gotosocial-token  (after creating user)
          {% endif %}
          {% endif %}

          ══════════════════════════════════════════════════════════════
      tags: [always]

  # ===========================================================================
  # HANDLERS
  # ===========================================================================

  handlers:
    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
