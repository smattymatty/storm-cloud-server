# =============================================================================
# Storm Cloud Server - Deployment Playbook
# =============================================================================
#
# One-command deployment for Storm Cloud Server.
#
# Usage:
#   make deploy                    # From project root
#   make deploy-check              # Dry run (no changes)
#   make deploy-app                # Update app only
#
# Manual:
#   cd deploy/ansible
#   ansible-playbook playbook.yml -i inventory.yml --extra-vars "@../config.yml"
#
# =============================================================================

---
- name: Deploy Storm Cloud Server
  hosts: all
  become: true

  vars:
    app_user: "{{ app_user | default('stormcloud') }}"
    install_path: "/home/{{ app_user }}/storm-cloud-server"
    web_port: "{{ web_port | default('8000') }}"
    cors_origins: "{{ cors_origins | default('') }}" # CORS origins from config.yml

  # ===========================================================================
  # PROMPTS
  # ===========================================================================

  vars_prompt:
    - name: gotosocial_username
      prompt: "GoToSocial username (leave blank to skip account creation)"
      private: false
      default: ""

    - name: gotosocial_email
      prompt: "GoToSocial email (leave blank to skip)"
      private: false
      default: ""

    - name: gotosocial_password
      prompt: "GoToSocial password (leave blank to skip)"
      private: true
      default: ""

    - name: gotosocial_make_admin
      prompt: "Make GoToSocial user an admin? (yes/no)"
      private: false
      default: "yes"

  # ===========================================================================
  # PRE-FLIGHT
  # ===========================================================================

  pre_tasks:
    - name: Validate config
      ansible.builtin.assert:
        that:
          - server_ip | default('') | length > 0
          - domain | default('') | length > 0
          - admin_email | default('') | length > 0
          - postgres_password | default('') | length > 0
        fail_msg: |

          ══════════════════════════════════════════════════════════════
          Missing required config. Edit deploy/config.yml:

            server_ip:       {{ server_ip | default('(empty)') }}
            domain:          {{ domain | default('(empty)') }}
            admin_email:     {{ admin_email | default('(empty)') }}
            postgres_password: {{ postgres_password | default('(empty)') }}

          ══════════════════════════════════════════════════════════════
      tags: [always]

    - name: Validate GoToSocial config
      ansible.builtin.assert:
        that:
          - gotosocial_domain | default('') | length > 0
        fail_msg: |

          ══════════════════════════════════════════════════════════════
          GoToSocial is enabled but gotosocial_domain is not set.
          Edit deploy/config.yml and set:

            gotosocial_domain: "social.example.com"

          ══════════════════════════════════════════════════════════════
      when: install_gotosocial | default(false)
      tags: [always]

    - name: Show deployment info
      ansible.builtin.debug:
        msg: |

          ══════════════════════════════════════════════════════════════
          Deploying Storm Cloud Server

            Server:  {{ server_ip }}
            Domain:  {{ domain }}
            User:    {{ app_user }}
          {% if install_gotosocial | default(false) %}

            GoToSocial: {{ gotosocial_domain }}
          {% endif %}
          ══════════════════════════════════════════════════════════════
      tags: [always]

  # ===========================================================================
  # ROLES
  # ===========================================================================

  roles:
    - role: geerlingguy.docker
      when: install_docker | default(true)
      vars:
        docker_users: ["{{ app_user }}"]
      tags: [docker]

  # ===========================================================================
  # TASKS
  # ===========================================================================

  tasks:
    # -------------------------------------------------------------------------
    # System
    # -------------------------------------------------------------------------

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: [system]

    - name: Install packages
      ansible.builtin.apt:
        name: [git, curl, ufw, acl]
        state: present
      tags: [system]

    - name: Create app user
      ansible.builtin.user:
        name: "{{ app_user }}"
        shell: /bin/bash
        groups: docker
        append: true
      tags: [system]

    # -------------------------------------------------------------------------
    # Firewall
    # -------------------------------------------------------------------------

    - name: Allow SSH
      community.general.ufw:
        rule: allow
        name: OpenSSH
      when: configure_firewall | default(true)
      tags: [firewall]

    - name: Allow HTTP
      community.general.ufw:
        rule: allow
        port: "80"
      when: configure_firewall | default(true)
      tags: [firewall]

    - name: Allow HTTPS
      community.general.ufw:
        rule: allow
        port: "443"
      when: configure_firewall | default(true)
      tags: [firewall]

    - name: Enable firewall
      community.general.ufw:
        state: enabled
        policy: deny
      when: configure_firewall | default(true)
      tags: [firewall]

    # -------------------------------------------------------------------------
    # Nginx (initial)
    # -------------------------------------------------------------------------

    - name: Install nginx
      ansible.builtin.apt:
        name: nginx
        state: present
      when: install_nginx | default(true)
      tags: [nginx]

    - name: Create certbot webroot
      ansible.builtin.file:
        path: /var/www/certbot
        state: directory
        mode: "0755"
      tags: [nginx]

    - name: Check if SSL cert exists
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      register: ssl_cert
      tags: [nginx, ssl]

    - name: Deploy pre-SSL nginx config
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/stormcloud
        mode: "0644"
        content: |
          server {
              listen 80;
              server_name {{ domain }};

              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }

              location / {
                  return 200 'Storm Cloud - awaiting SSL\n';
                  add_header Content-Type text/plain;
              }
          }
      when:
        - install_nginx | default(true)
        - not ssl_cert.stat.exists | default(true)
      notify: Reload nginx
      tags: [nginx]

    - name: Enable site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/stormcloud
        dest: /etc/nginx/sites-enabled/stormcloud
        state: link
      when: install_nginx | default(true)
      notify: Reload nginx
      tags: [nginx]

    - name: Check if GoToSocial SSL cert exists
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ gotosocial_domain }}/fullchain.pem"
      register: gotosocial_ssl_cert_initial
      when: install_gotosocial | default(false)
      tags: [nginx, ssl, gotosocial]

    - name: Deploy pre-SSL nginx config for GoToSocial
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/gotosocial
        mode: "0644"
        content: |
          server {
              listen 80;
              server_name {{ gotosocial_domain }};

              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }

              location / {
                  return 200 'GoToSocial - awaiting SSL\n';
                  add_header Content-Type text/plain;
              }
          }
      when:
        - install_gotosocial | default(false)
        - install_nginx | default(true)
        - not (gotosocial_ssl_cert_initial.stat.exists | default(false))
      notify: Reload nginx
      tags: [nginx, gotosocial]

    - name: Enable GoToSocial site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/gotosocial
        dest: /etc/nginx/sites-enabled/gotosocial
        state: link
      when:
        - install_gotosocial | default(false)
        - install_nginx | default(true)
      notify: Reload nginx
      tags: [nginx, gotosocial]

    - name: Remove default site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx
      tags: [nginx]

    - name: Start nginx
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
      when: install_nginx | default(true)
      tags: [nginx]

    - name: Flush handlers for certbot
      ansible.builtin.meta: flush_handlers
      tags: [nginx, ssl]

    # -------------------------------------------------------------------------
    # SSL
    # -------------------------------------------------------------------------

    - name: Install certbot
      ansible.builtin.apt:
        name: [certbot, python3-certbot-nginx]
        state: present
      when: install_certbot | default(true)
      tags: [ssl]

    - name: Get SSL certificate
      ansible.builtin.command:
        cmd: >-
          certbot certonly --webroot
          --webroot-path=/var/www/certbot
          --email {{ admin_email }}
          --agree-tos --no-eff-email --non-interactive
          -d {{ domain }}
        creates: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      when: install_certbot | default(true)
      tags: [ssl]

    - name: Get SSL certificate for GoToSocial
      ansible.builtin.command:
        cmd: >-
          certbot certonly --webroot
          --webroot-path=/var/www/certbot
          --email {{ admin_email }}
          --agree-tos --no-eff-email --non-interactive
          -d {{ gotosocial_domain }}
        creates: "/etc/letsencrypt/live/{{ gotosocial_domain }}/fullchain.pem"
      when:
        - install_gotosocial | default(false)
        - install_certbot | default(true)
      tags: [ssl, gotosocial]

    - name: Re-check SSL cert
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      register: ssl_cert_final
      tags: [nginx, ssl]

    - name: Re-check GoToSocial SSL cert
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ gotosocial_domain }}/fullchain.pem"
      register: gotosocial_ssl_cert
      when: install_gotosocial | default(false)
      tags: [nginx, ssl, gotosocial]

    - name: Deploy full nginx config
      ansible.builtin.template:
        src: templates/nginx-stormcloud.conf.j2
        dest: /etc/nginx/sites-available/stormcloud
        mode: "0644"
      when:
        - install_nginx | default(true)
        - ssl_cert_final.stat.exists
        - (not install_gotosocial | default(false)) or (gotosocial_ssl_cert.stat.exists | default(false))
      notify: Reload nginx
      tags: [nginx, ssl]

    - name: Remove temporary GoToSocial nginx config
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/nginx/sites-enabled/gotosocial
        - /etc/nginx/sites-available/gotosocial
      when:
        - install_gotosocial | default(false)
        - gotosocial_ssl_cert.stat.exists | default(false)
      notify: Reload nginx
      tags: [nginx, ssl, gotosocial]

    # -------------------------------------------------------------------------
    # Application
    # -------------------------------------------------------------------------

    - name: Clone repository
      ansible.builtin.git:
        repo: "{{ repo_url | default('https://github.com/smattymatty/storm-cloud-server.git') }}"
        dest: "{{ install_path }}"
        version: "{{ git_branch | default('main') }}"
        update: true
      become_user: "{{ app_user }}"
      register: git_result
      tags: [app]

    - name: Create directories
      ansible.builtin.file:
        path: "{{ install_path }}/{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        mode: "0755"
      loop: [uploads, backups]
      tags: [app]

    - name: Create GoToSocial data directory
      ansible.builtin.file:
        path: "{{ install_path }}/gotosocial_data"
        state: directory
        owner: "{{ app_user }}"
        mode: "0755"
      when: install_gotosocial | default(false)
      tags: [app, gotosocial]

    # -------------------------------------------------------------------------
    # Secrets (idempotent)
    # -------------------------------------------------------------------------

    - name: Check for existing .env
      ansible.builtin.stat:
        path: "{{ install_path }}/.env"
      register: env_check
      tags: [app, env]

    # First deploy: generate new secrets
    - name: Generate secrets (new install)
      ansible.builtin.set_fact:
        secret_key: "{{ lookup('password', '/dev/null length=50 chars=ascii_letters,digits') }}"
        db_password: "{{ postgres_password }}"
      when: not env_check.stat.exists
      tags: [app, env]

    # Existing deploy: read and preserve secrets
    - name: Read existing .env
      ansible.builtin.slurp:
        src: "{{ install_path }}/.env"
      register: env_content
      when: env_check.stat.exists
      tags: [app, env]

    - name: Parse existing secrets
      ansible.builtin.set_fact:
        secret_key: "{{ env_content.content | b64decode | regex_search('SECRET_KEY=(.+)$', '\\1', multiline=True) | first }}"
        db_password: "{{ env_content.content | b64decode | regex_search('POSTGRES_PASSWORD=(.+)$', '\\1', multiline=True) | first }}"
      when: env_check.stat.exists
      tags: [app, env]

    - name: Write .env
      ansible.builtin.template:
        src: templates/dotenv.j2
        dest: "{{ install_path }}/.env"
        owner: "{{ app_user }}"
        mode: "0600"
      tags: [app, env]

    # -------------------------------------------------------------------------
    # Docker
    # -------------------------------------------------------------------------

    - name: Build images (fresh rebuild)
      ansible.builtin.command:
        cmd: docker compose build --no-cache
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when: git_result.changed
      tags: [app, docker]

    - name: Start containers
      ansible.builtin.command:
        cmd: "docker compose {{ '--profile gotosocial' if install_gotosocial | default(false) else '' }} up -d --remove-orphans"
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      register: up_result
      changed_when: "'Started' in up_result.stdout or 'Creating' in up_result.stdout"
      tags: [app, docker]

    - name: Wait for healthy
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ web_port }}/api/v1/health/ping/"
        status_code: 200
      register: health
      until: health.status == 200
      retries: 30
      delay: 2
      tags: [app, docker]

    # -------------------------------------------------------------------------
    # GoToSocial Account Setup
    # -------------------------------------------------------------------------

    - name: Wait for GoToSocial healthy
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 8081
        delay: 5
        timeout: 60
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
      tags: [app, gotosocial]

    - name: Create GoToSocial account
      ansible.builtin.command:
        cmd: >-
          docker exec stormcloud_gotosocial
          /gotosocial/gotosocial admin account create
          --username {{ gotosocial_username }}
          --email {{ gotosocial_email }}
          --password {{ gotosocial_password }}
      become_user: "{{ app_user }}"
      register: gts_create
      failed_when: false
      changed_when: "'created' in gts_create.stdout.lower() or 'Created' in gts_create.stdout"
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
        - gotosocial_email | default('') | length > 0
        - gotosocial_password | default('') | length > 0
      tags: [app, gotosocial]

    - name: Confirm GoToSocial account
      ansible.builtin.command:
        cmd: >-
          docker exec stormcloud_gotosocial
          /gotosocial/gotosocial admin account confirm
          --username {{ gotosocial_username }}
      become_user: "{{ app_user }}"
      register: gts_confirm
      failed_when: false
      changed_when: "'confirmed' in gts_confirm.stdout.lower() or 'Confirmed' in gts_confirm.stdout"
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
        - gts_create is defined
      tags: [app, gotosocial]

    - name: Promote GoToSocial account to admin
      ansible.builtin.command:
        cmd: >-
          docker exec stormcloud_gotosocial
          /gotosocial/gotosocial admin account promote
          --username {{ gotosocial_username }}
      become_user: "{{ app_user }}"
      register: gts_promote
      failed_when: false
      changed_when: "'promoted' in gts_promote.stdout.lower() or 'Promoted' in gts_promote.stdout"
      when:
        - install_gotosocial | default(false)
        - gotosocial_username | default('') | length > 0
        - gotosocial_make_admin | default('yes') in ['yes', 'y', 'Y', 'YES', 'Yes']
        - gts_confirm is defined
      tags: [app, gotosocial]

    - name: Restart GoToSocial for admin changes
      ansible.builtin.command:
        cmd: docker restart stormcloud_gotosocial
        chdir: "{{ install_path }}"
      become_user: "{{ app_user }}"
      when:
        - install_gotosocial | default(false)
        - gts_promote is defined
        - gts_promote is changed
      tags: [app, gotosocial]

    # -------------------------------------------------------------------------
    # Done
    # -------------------------------------------------------------------------

    - name: Success
      ansible.builtin.debug:
        msg: |

          ══════════════════════════════════════════════════════════════
          ✓ Deployed!
          ══════════════════════════════════════════════════════════════

          Live at: https://{{ domain }}

          Next steps:

            ssh {{ ssh_user | default('root') }}@{{ server_ip }}
            su - {{ app_user }}
            cd {{ install_path }}
            make superuser
            make api_key
          {% if install_gotosocial | default(false) %}

          ──────────────────────────────────────────────────────────────
          GoToSocial: https://{{ gotosocial_domain }}
          {% if gotosocial_username | default('') | length > 0 %}

            ✓ Account created: {{ gotosocial_username }}
            {% if gotosocial_make_admin | default('yes') in ['yes', 'y', 'Y', 'YES', 'Yes'] %}
            ✓ Admin privileges granted
            {% endif %}

            Next: Generate API token for Django integration
              make gotosocial-token
          {% else %}

            To create a user account:
              make gotosocial-user   (interactive)
              make gotosocial-token  (after creating user)
          {% endif %}
          {% endif %}

          ══════════════════════════════════════════════════════════════
      tags: [always]

  # ===========================================================================
  # HANDLERS
  # ===========================================================================

  handlers:
    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
